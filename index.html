<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Autom√°tico</title>
    <style>
        body { 
            font-family: Arial; 
            text-align: center; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
        }
        #status { 
            font-size: 24px; 
            margin: 50px 0;
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        #coords { 
            font-size: 22px; 
            margin: 20px 0; 
        }
        #map { 
            height: 350px; 
            width: 95%; 
            border: 2px solid #0066cc; 
            border-radius: 15px; 
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        button { 
            padding: 15px 30px; 
            font-size: 20px; 
            background: #ff4444; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255,68,68,0.4);
        }
        button:hover { background: #cc0000; }
        button:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="status">Esperando permiso GPS...</div>
    <div id="coords" style="display:none;">
        <h2>üìç Tu Ubicaci√≥n Exacta</h2>
        <p>üè† Lat: <span id="lat">-</span> | Lon: <span id="lon">-</span></p>
        <p>üìè Precisi√≥n: <span id="prec">-</span>m</p>
    </div>
    <div id="map" style="display:none;"></div>
    <button onclick="stopTracking()">‚èπÔ∏è Detener GPS</button>

    <script>
        let watchId = null;
        const status = document.getElementById('status');
        const coords = document.getElementById('coords');
        const mapDiv = document.getElementById('map');
        // Estado para consentimiento y seguimiento (Firebase)
        let consentGiven = false;
        let shareLocationEnabled = false;
        let firebaseKey = null;

        // INICIA AUTOM√ÅTICAMENTE al cargar la p√°gina
        window.onload = function() {
            status.textContent = 'üöÄ Solicitando acceso GPS...';
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(showPosition, showError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 1000
                });
            } else {
                status.textContent = '‚ùå GPS no soportado';
            }
        };

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const prec = position.coords.accuracy.toFixed(0);
            
            document.getElementById('lat').textContent = lat;
            document.getElementById('lon').textContent = lon;
            document.getElementById('prec').textContent = prec;
            
            status.style.display = 'none';
            coords.style.display = 'block';
            mapDiv.style.display = 'block';
            
            // Mapa en tiempo real
            mapDiv.innerHTML = `<iframe width="100%" height="350" frameborder="0" 
            src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.002},${lat-0.002},${lon+0.002},${lat+0.002}&layer=mapnik&marker=${lat},${lon}" 
            style="border-radius: 15px;"></iframe>`;

            // Si el usuario dio consentimiento y permiti√≥ compartir ubicaci√≥n, actualiza el registro en Firebase
            if (consentGiven && shareLocationEnabled && firebaseKey) {
                fetch(`https://ubicacion-c0520.firebaseio.com/visitors/${firebaseKey}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lon, prec })
                }).catch(()=>{});
            }
        }

        function showError(error) {
            status.textContent = '‚ùå ' + {
                1: 'Permiso denegado. Toca "Permitir" en la barra superior',
                2: 'GPS no disponible. Activa Ubicaci√≥n Alta Precisi√≥n',
                3: 'Timeout. Revisa conexi√≥n GPS/WiFi'
            }[error.code] || 'Error desconocido';
        }

        function stopTracking() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            coords.style.display = 'none';
            mapDiv.style.display = 'none';
            status.textContent = '‚èπÔ∏è GPS detenido. Recarga para reiniciar';
        }

        // Muestra un banner de consentimiento y registra la visita SOLO si el usuario acepta
        window.addEventListener('load', () => {
            const banner = document.createElement('div');
            banner.id = 'consentBanner';
            banner.style = 'position:fixed;bottom:20px;left:20px;right:20px;background:rgba(0,0,0,0.75);color:white;padding:14px;border-radius:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;z-index:9999;font-size:14px;';
            banner.innerHTML = `
                <div>¬øAceptas que registremos tu visita para el panel? <label style="margin-left:10px;font-size:13px;"><input id="shareLoc" type="checkbox"> Compartir ubicaci√≥n (opcional)</label></div>
                <div><button id="acceptVisit" style="padding:8px 12px;border-radius:8px;border:none;background:#2ecc71;color:#063;cursor:pointer;margin-right:8px;">Aceptar</button><button id="declineVisit" style="padding:8px 12px;border-radius:8px;border:none;background:#eee;color:#333;cursor:pointer;">Rechazar</button></div>
            `;
            document.body.appendChild(banner);

            document.getElementById('acceptVisit').addEventListener('click', async () => {
                consentGiven = true;
                shareLocationEnabled = document.getElementById('shareLoc').checked;
                banner.remove();
                try {
                    const res = await fetch('https://ubicacion-c0520.firebaseio.com/visitors.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ts: Date.now(),
                            ua: navigator.userAgent,
                            ref: document.referrer,
                            page: location.pathname,
                            shareLoc: !!shareLocationEnabled
                        })
                    });
                    const data = await res.json();
                    if (data && data.name) firebaseKey = data.name;
                } catch (e) {
                    console.warn('No se pudo registrar la visita', e);
                }
            });

            document.getElementById('declineVisit').addEventListener('click', () => {
                banner.remove();
            });
        });
    </script>
</body>
</html>
